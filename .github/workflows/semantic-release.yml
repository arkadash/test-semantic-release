name: Semantic Release

on:
  push:
    branches:
      - production
    paths-ignore:
      - 'CHANGELOG.md'
      - 'package.json'
      - 'package-lock.json'
  workflow_dispatch:

jobs:
  release:
    runs-on: ubuntu-latest
    outputs:
      new_release_published: ${{ steps.semantic.outputs.new_release_published }}
      new_release_version: ${{ steps.semantic.outputs.new_release_version }}
    permissions:
      contents: write
      issues: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "lts/*"

      - name: Install semantic-release dependencies
        run: |
          npm install --save-dev \
            semantic-release \
            @semantic-release/git \
            @semantic-release/github \
            @semantic-release/changelog \
            @semantic-release/commit-analyzer \
            @semantic-release/release-notes-generator \
            conventional-changelog-conventionalcommits

      - name: Setup Git
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'

      - name: Create semantic-release config
        run: |
          cat << EOF > .releaserc.json
          {
            "branches": ["production"],
            "plugins": [
              ["@semantic-release/commit-analyzer", {
                "preset": "angular",
                "parserOpts": {
                  "noteKeywords": ["BREAKING CHANGE", "BREAKING CHANGES"]
                },
                "releaseRules": [
                  {"breaking": true, "release": "major"},
                  {"type": "feat", "release": "minor"},
                  {"type": "fix", "release": "patch"},
                  {"type": "docs", "release": "patch"},
                  {"type": "perf", "release": "patch"},
                  {"type": "refactor", "release": "patch"},
                  {"type": "style", "release": "patch"},
                  {"type": "test", "release": "patch"},
                  {"type": "chore", "release": "patch"},
                  {"type": "revert", "release": "patch"},
                  {"type": "ci", "release": "patch"},
                  {"type": "build", "release": "patch"},
                  {"scope": "*", "release": "patch"},
                  {"subject": "*", "release": "patch"},
                  {"message": "*", "release": "patch"}
                ]
              }],
              ["@semantic-release/release-notes-generator", {
                "preset": "conventionalcommits",
                "parserOpts": {
                  "noteKeywords": ["BREAKING CHANGE", "BREAKING CHANGES"]
                },
                "writerOpts": {
                  "commitsSort": ["subject", "scope"],
                  "commitGroupsSort": ["title", "raw"],
                  "noteGroupsSort": ["title", "raw"],
                  "mainTemplate": "{{> header}}\n\n{{#each commitGroups}}\n\n{{#if title}}\n### {{title}}\n\n{{/if}}\n{{#each commits}}\n{{> commit root=@root}}\n{{/each}}\n{{/each}}\n\n{{> footer}}",
                  "headerPartial": "## {{version}} ({{date}})",
                  "commitPartial": "* {{#if scope}}**{{scope}}:** {{/if}}{{subject}} ({{shortHash}})",
                  "footerPartial": "{{> footer}}"
                },
                "presetConfig": {
                  "types": [
                    {"type": "feat", "section": "Features"},
                    {"type": "fix", "section": "Bug Fixes"},
                    {"type": "docs", "section": "Documentation"},
                    {"type": "perf", "section": "Performance"},
                    {"type": "refactor", "section": "Refactoring"},
                    {"type": "build", "section": "Build"},
                    {"type": "ci", "section": "CI/CD"},
                    {"type": "chore", "section": "Chores"},
                    {"type": "revert", "section": "Reverts"},
                    {"type": "style", "section": "Styling"},
                    {"type": "test", "section": "Tests"},
                    {"type": "other", "section": "Other Changes"}
                  ]
                }
              }],
              ["@semantic-release/changelog", {
                "changelogFile": "CHANGELOG.md"
              }],
              ["@semantic-release/github", {
                "assets": [],
                "successComment": "ðŸŽ‰ This PR is included in version \${nextRelease.version}",
                "releasedLabels": ["shipped"],
                "addReleases": "bottom"
              }],
              ["@semantic-release/git", {
                "assets": ["CHANGELOG.md", "package.json"],
                "message": "chore(release): \${nextRelease.version} [skip ci]\n\nJIRA Tickets: \${nextRelease.notes}"
              }]
            ]
          }
          EOF

      - name: Release
        id: semantic
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GIT_AUTHOR_NAME: 'github-actions[bot]'
          GIT_AUTHOR_EMAIL: 'github-actions[bot]@users.noreply.github.com'
          GIT_COMMITTER_NAME: 'github-actions[bot]'
          GIT_COMMITTER_EMAIL: 'github-actions[bot]@users.noreply.github.com'
        run: npx semantic-release